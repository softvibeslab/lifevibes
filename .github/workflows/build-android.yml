name: Build Android APK

# Trigger: Se ejecuta al hacer push a main o al crear un PR
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecutar manualmente desde la UI

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del código
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configurar Java JDK
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Configurar Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      # 4. Verificar instalación de Flutter
      - name: Verify Flutter
        run: flutter doctor -v

      # 5. Obtener dependencias
      - name: Install dependencies
        run: flutter pub get

      # 6. Ejecutar tests (opcional, falla si no hay tests)
      - name: Run tests
        run: flutter test || echo "No tests found, continuing..."

      # 7. Build APK Release
      - name: Build APK
        run: flutter build apk --release

      # 8. Renombrar APK con versión y número de build
      - name: Rename APK
        run: |
          VERSION=$(grep 'version: ' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          BUILD_NUMBER=$(grep 'version: ' pubspec.yaml | cut -d '+' -f 2)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/lifevibes-${VERSION}+${BUILD_NUMBER}-${COMMIT_SHA}.apk

      # 9. Publicar APK como artefacto ( válido por 30 días)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: lifevibes-apk-release
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      # 10. Publicar también APK debug para pruebas rápidas
      - name: Build Debug APK
        run: flutter build apk --debug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: lifevibes-apk-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  # Job adicional: Crear release cuando se crea un tag
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: lifevibes-apk-release
          path: ./apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./apk/*.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
